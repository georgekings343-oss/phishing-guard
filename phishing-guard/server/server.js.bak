require("dotenv").config();
const express = require("express");
const cors = require("cors");
const mongoose = require("mongoose");

const app = express();

// âœ… Middleware
app.use(express.json());

// âœ… CORS configuration
const FRONTEND_URL = process.env.FRONTEND_URL || "http://localhost:5173"; // frontend URL
app.use(cors({
  origin: FRONTEND_URL,
  credentials: true,
}));

// âœ… Connect to MongoDB
mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log("âœ… MongoDB connected successfully"))
  .catch(err => {
    console.error("âŒ Database connection failed:", err.message);
    process.exit(1);
  });

// âœ… Import routes safely
let authRoutes, settingsRoutes, dashboardRoutes, incidentsRoutes;

try {
  authRoutes = require("./routes/auth");
} catch (err) {
  console.warn("âš ï¸ auth routes not found, using empty router");
  authRoutes = express.Router();
}

try {
  settingsRoutes = require("./routes/settings");
} catch (err) {
  console.warn("âš ï¸ settings routes not found, using empty router");
  settingsRoutes = express.Router();
}

try {
  dashboardRoutes = require("./routes/dashboard");
} catch (err) {
  console.warn("âš ï¸ dashboard routes not found, using empty router");
  dashboardRoutes = express.Router();
}

try {
  incidentsRoutes = require("./routes/incidents");
} catch (err) {
  console.warn("âš ï¸ incidents routes not found, using empty router");
  incidentsRoutes = express.Router();
}

// âœ… Register routes
app.use("/api/auth", authRoutes);
app.use("/api/settings", settingsRoutes);
app.use("/api/dashboard", dashboardRoutes);
app.use("/api/incidents", incidentsRoutes);

// âœ… Dummy login route for frontend testing
app.post("/api/auth/login", (req, res) => {
  const { email, password } = req.body;

  // Dummy login logic
  if (email === "admin@smartmove.com" && password === "admin123") {
    return res.json({ token: "fake-jwt-token", user: { email } });
  } else {
    return res.status(401).json({ message: "Invalid credentials" });
  }
});

// âœ… Health check
app.get("/api/health", (req, res) => {
  res.json({ status: "ok", message: "Server is running" });
});

// âœ… Root route
app.get("/", (req, res) => {
  res.send("ðŸš€ SmartMove Backend API is running!");
});

// âœ… Start server
const PORT = process.env.PORT || 4000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on http://localhost:${PORT}`);
});
